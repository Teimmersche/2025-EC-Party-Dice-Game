<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025尾牙遊戲(測試版)</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            background-image: url('https://png.pngtree.com/thumb_back/fh260/background/20190223/ourmid/pngtree-fresh-sweet-watercolor-soft-gradient-border-background-colorgradientsimpleframe-image_75501.jpg');
            background-size: 100vw 100vh; /* 設置圖片大小為整個視窗寬高 */
            background-repeat: no-repeat; /* 防止重複 */
            background-position: center center; /* 圖片置中 */
            background-attachment: fixed; /* 背景固定不隨滾動 */
        }
        .board {
            display: grid;
            grid-template-columns: repeat(11, minmax(30px, 1fr));
            grid-template-rows: repeat(11, minmax(30px, 1fr));
            width: 90vmin;
            height: 90vmin;
            margin: 20px;
            position: relative;
            gap: 2px;
            justify-content: center;
            align-items: center;
        }
        .node {
            width: 60px; /* 增加寬度 */
            height: 60px; /* 增加高度 */
            display: flex;
            flex-direction: column; /* 改為縱向排列 */
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            position: relative;
            margin: 2px;
            font-size: 12px; /* 調整字體大小 */
            word-wrap: break-word; /* 允許文字換行 */
            overflow: visible; /* 改為visible */
            box-sizing: border-box;
            line-height: 1;
        }

        .node.corner {
            background-color: #ffdd57;
            font-weight: bold;
        }
        .node.path {
            background-color: #a5d8ff;
        }
        .player {
            width: 20px;
            height: 20px;
            margin-bottom: 2px;
            background-color: red;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .controls, .scoreboard {
            text-align: center;
        }
        .button {
            margin: 10px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .scoreboard {
            margin-top: 20px;
        }
        .scoreboard table {
            border-collapse: collapse;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .scoreboard th, .scoreboard td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .scoreboard th {
            background-color: #007bff;
            color: white;
        }
        .question-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .question-container h2 {
            margin-bottom: 20px;
        }
        .question-container button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        .question-container button.correct {
            background-color: #28a745;
            color: white;
        }
        .question-container button.incorrect {
            background-color: #dc3545;
            color: white;
        }
      .scoreboard, .history {
    display: none; /* 隱藏計分版和遊玩紀錄 */
}
        .history {
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        .history table {
            border-collapse: collapse;
            width: 100%;
        }
        .history th, .history td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .history th {
            background-color: #007bff;
            color: white;
        }
        .dice {
            width: 50px;
            height: 50px;
            position: relative;
            margin: 10px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .dice-face {
            width: 100%;
            height: 100%;
            background-color: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            position: relative;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5%;
        }
        .dot {
            width: 50%;
            height: 50%;
            background-color: #007bff;
            border-radius: 50%;
            place-self: center;
        }
        @keyframes rollDice {
            0% {
                transform: rotateX(0deg) rotateY(0deg);
            }
            25% {
                transform: rotateX(90deg) rotateY(0deg);
            }
            50% {
                transform: rotateX(90deg) rotateY(90deg);
            }
            75% {
                transform: rotateX(180deg) rotateY(90deg);
            }
            100% {
                transform: rotateX(360deg) rotateY(360deg);
            }
        }
        .dice.animate .dice-face {
            animation: rollDice 1s cubic-bezier(0.25, 1, 0.5, 1);
        }
.node::before {
    word-wrap: break-word;
    text-align: center;
    max-width: 100%; /* 讓文字限制在節點寬度內 */
}
      .node {
            position: relative; /* 確保 ::before 以節點為參考點 */
      }
      .node {
    margin: 5px; /* 調整節點之間的間距 */
}
      .hidden-node {
    visibility: hidden; /* 隱藏節點內容，但保留空間 */
    background-color: transparent; /* 確保背景透明 */
    border: none; /* 移除邊框 */
}
      .node[data-category="技術"] {
    background-color: #f4d03f; /* 技術 - 黃色 */
}
      .node[data-category="生活"] {
    background-color: #76d7c4; /* 生活 - 綠色 */
}
      .node[data-category="人物"] {
    background-color: #a569bd; /* 人物 - 紫色 */
}
      .node[data-category="時事"] {
    background-color: #5dade2; /* 時事 - 藍色 */
}

      .board {
    gap: 4px; /* 增加節點間距 */
}
@media (max-width: 600px) {
    .board {
        width: 95vw; /* 使用視窗寬度的 95% */
        height: 95vw; /* 確保是正方形 */
        gap: 2px; /* 減少節點間的間距 */
    }
    .node {
        width: auto; /* 自動調整節點大小 */
        height: auto;
        font-size: 10px; /* 縮小文字大小 */
    }
  #choiceContainer {
    display: none; /* 預設隱藏 */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 2px solid #ccc;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
}
.wish-modal {
            /* 初始狀態設為隱藏 */
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            /* 固定寬度和高度 */
            width: 400px;
            height: 300px;
            /* 防止調整大小 */
            resize: none;
            /* 防止拖曳 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .wish-modal h2 {
            color: #d4af37;
            text-align: center;
            margin-bottom: 20px;
            /* 防止文字被選取 */
            user-select: none;
        }

        .wish-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* 設定固定高度 */
            height: calc(100% - 60px);
        }

        .wish-input {
            /* 設定固定大小 */
            width: calc(100% - 20px);
            height: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            /* 允許文字區域的垂直滾動 */
            resize: none;
            overflow-y: auto;
        }

        .wish-submit {
            background-color: #d4af37;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            /* 保持在底部 */
            margin-top: auto;
        }

        .wish-submit:hover {
            background-color: #c19b2c;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            /* 防止互動 */
            pointer-events: none;
        }

        /* 當視窗較小時的響應式設計 */
        @media (max-width: 500px) {
            .wish-modal {
                width: 90%;
                height: 280px;
            }
            
            .wish-input {
                height: 120px;
            }
            @media screen and (max-width: 768px) {
    body {
        padding: 10px;
        font-size: 14px;
    }

    .board {
        width: 95vmin;
        height: 95vmin;
        gap: 1px;
    }

    .node {
        width: calc(95vmin / 11 - 2px);
        height: calc(95vmin / 11 - 2px);
        font-size: 10px;
        padding: 2px;
    }

    .controls {
        margin: 10px 0;
    }

    .button {
        padding: 8px 16px;
        font-size: 14px;
        margin: 5px;
        min-height: 44px; /* 確保觸控區域足夠大 */
    }

    .dice {
        width: 40px;
        height: 40px;
    }

    .question-container {
        width: 90%;
        max-width: 400px;
        padding: 15px;
    }

    .question-container button {
        min-height: 44px;
        margin: 8px 0;
        font-size: 14px;
    }

    .wish-modal {
        width: 90%;
        max-width: 400px;
        height: auto;
        padding: 15px;
    }

    .wish-input {
        height: 100px;
    }
}
            .button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
    
    .scoreboard-btn {
        background-color: #28a745; /* 使用綠色來區分不同功能的按鈕 */
    }
    
    .scoreboard-btn:hover {
        background-color: #218838;
    }
    
    @media screen and (max-width: 768px) {
        .button-group {
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .button {
            width: 200px; /* 在手機版面上設定固定寬度 */
            min-height: 44px; /* 確保觸控面積足夠 */
        }
    }
    </style>

</head>
<body>
    <h1>2025尾牙遊戲(測試版)</h1>
    <div class="controls">
    <p>玩家名稱：<input type="text" id="name" placeholder="輸入名字" /></p>
    <div class="button-group">
        <button class="button" id="startGame">開始遊戲</button>
        <button class="button scoreboard-btn" id="viewScoreboard" onclick="window.location.href='result.html'">查看排行榜</button>
    </div>
</div>
<div class="board" id="board" style="display: none;"></div>
<div class="controls" style="display: none;" id="gameControls">
        <p>當前分數：<span id="score">100</span></p>
        <p>擲骰結果：<span id="diceResult">-</span></p>
        <div class="dice" id="dice">
            <div class="dice-face" id="diceFace"></div>
        </div>
        <button class="button" id="rollDice">擲骰</button>
    </div>
    <div class="scoreboard">
        <h2>計分版</h2>
        <table>
            <thead>
                <tr>
                    <th>玩家名稱</th>
                    <th>最終分數</th>
                </tr>
            </thead>
            <tbody id="scoreboard"></tbody>
        </table>
    </div>
    <div class="history">
        <h2>遊玩紀錄</h2>
        <table>
            <thead>
                <tr>
                    <th>玩家名稱</th>
                    <th>最終分數</th>
                    <th>遊玩時間</th>
                </tr>
            </thead>
            <tbody id="history"></tbody>
        </table>
    </div>
    <div class="question-container" id="questionContainer">
        <h2 id="questionText">問題</h2>
        <div id="options"></div>
    </div>
  <div class="question-container" id="choiceContainer">
    <h2>是否答題？</h2>
    <button id="answerButton" class="button">答題</button>
    <button id="passButton" class="button">跳過 (-10分)</button>
</div>
<div class="modal-overlay" id="wishOverlay"></div>
    <div class="wish-modal" id="wishModal">
        <h2>🌟 新年祝福 2025 🌟</h2>
        <form class="wish-form" id="wishForm">
            <textarea 
                class="wish-input" 
                placeholder="在這裡寫下你的新年期許或祝福..."
                maxlength="200"
                required
            ></textarea>
            <button type="submit" class="wish-submit">送出祝福</button>
        </form>
    </div>
    <script>
        // Google Apps Script 網頁應用程式網址
const googleAppsScriptUrl = 'https://script.google.com/macros/s/AKfycbyem6VpFwrNopc5B_xWO8I6B7SsNvX41KJBzMcZMD_s-f8rxdiFOSO-p4olnvsGaM8/exec'; // 替換為您的網址

// 修改 sendGameResult 函數以確保正確處理 wish 參數
async function sendGameResult(playerName, score, wishText) {
    // 創建加載提示
    const loadingMessage = createLoadingMessage();
    document.body.appendChild(loadingMessage);

    try {
        // 準備數據
        const data = {
            playerName: playerName,
            score: score,
            wish: wishText || '',
            timestamp: new Date().toISOString()
        };

        // 使用 URL 搜索參數
        const params = new URLSearchParams(data);
        const url = `${googleAppsScriptUrl}?${params.toString()}`;

        // 設置請求選項
        const requestOptions = {
            method: 'GET',
            mode: 'cors',
            headers: {
                'Accept': 'application/json'
            },
            redirect: 'follow',
            referrerPolicy: 'no-referrer'
        };

        // 添加超時處理
        const timeout = 30000;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        requestOptions.signal = controller.signal;

        // 發送請求
        const response = await fetch(url, requestOptions);
        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.status === 'success') {
            // 顯示成功消息
            loadingMessage.textContent = '儲存成功！正在前往排行榜...';
            loadingMessage.style.background = 'rgba(0, 128, 0, 0.8)';
            
            // 延遲跳轉
            await new Promise(resolve => setTimeout(resolve, 2000));
            window.location.href = 'result.html';
        } else {
            throw new Error(result.message || '伺服器回應異常');
        }

    } catch (error) {
        console.error('Error:', error);
        handleError(error.message, loadingMessage);
    }
}

// 創建加載提示元素
function createLoadingMessage() {
    const loadingMessage = document.createElement('div');
    loadingMessage.style.position = 'fixed';
    loadingMessage.style.top = '50%';
    loadingMessage.style.left = '50%';
    loadingMessage.style.transform = 'translate(-50%, -50%)';
    loadingMessage.style.background = 'rgba(0, 0, 0, 0.8)';
    loadingMessage.style.color = 'white';
    loadingMessage.style.padding = '20px';
    loadingMessage.style.borderRadius = '10px';
    loadingMessage.style.zIndex = '9999';
    loadingMessage.textContent = '正在儲存資料...';
    return loadingMessage;
}

// 錯誤處理
function handleError(message, loadingMessage) {
    loadingMessage.textContent = `${message}\n點擊此處重試`;
    loadingMessage.style.background = 'rgba(255, 0, 0, 0.8)';
    loadingMessage.style.cursor = 'pointer';
    
    // 添加重試事件監聽器
    const retryHandler = async () => {
        loadingMessage.removeEventListener('click', retryHandler);
        document.body.removeChild(loadingMessage);
        await sendGameResult(playerName, score, wishText);
    };
    
    loadingMessage.addEventListener('click', retryHandler);
}

        const board = document.getElementById('board');
        const gameControls = document.getElementById('gameControls');
        const scoreDisplay = document.getElementById('score');
        const diceResultDisplay = document.getElementById('diceResult');
        const rollDiceButton = document.getElementById('rollDice');
        const nameInput = document.getElementById('name');
        const Button = document.getElementById('');
        const scoreboardTable = document.getElementById('scoreboard');
        const historyTable = document.getElementById('history');
        const questionContainer = document.getElementById('questionContainer');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('options');
        const diceFace = document.getElementById('diceFace');
      const choiceContainer = document.getElementById('choiceContainer');
const answerButton = document.getElementById('answerButton');
const passButton = document.getElementById('passButton');

const GameState = {
    saveState: function(state) {
        const gameState = {
            playerName: state.playerName,
            score: state.score,
            playerPosition: state.playerPosition,
            totalNodesTravelled: state.totalNodesTravelled,
            completedLaps: state.completedLaps,
            isGameOver: state.isGameOver,
            gameStartTime: state.gameStartTime || Date.now(),
            lastUpdateTime: Date.now()
        };
        
        localStorage.setItem('currentGameState', JSON.stringify(gameState));
        localStorage.setItem('gameInProgress', 'true');
    },

    loadState: function() {
        const savedState = localStorage.getItem('currentGameState');
        const gameInProgress = localStorage.getItem('gameInProgress');
        
        if (savedState && gameInProgress === 'true') {
            return JSON.parse(savedState);
        }
        return null;
    },

    clearState: function() {
        localStorage.removeItem('currentGameState');
        localStorage.removeItem('gameInProgress');
    },

    hasActiveGame: function() {
        return localStorage.getItem('gameInProgress') === 'true';
    },

    isStateValid: function(state) {
        if (!state || !state.lastUpdateTime) return false;
        const MAX_GAME_DURATION = 30 * 60 * 1000; // 30分鐘
        return (Date.now() - state.lastUpdateTime) < MAX_GAME_DURATION;
    }
};
        
// 玩家選擇答題
answerButton.addEventListener('click', () => {
    choiceContainer.style.display = "none"; // 隱藏選擇視窗
    askQuestion(playerPosition); // 呼叫題目顯示函數
});

// 玩家選擇跳過
passButton.addEventListener('click', () => {
    choiceContainer.style.display = "none"; // 隱藏選擇視窗
    score -= 10; // 扣除10分
    scoreDisplay.textContent = score; // 更新分數顯示
    rollDiceButton.disabled = false; // 啟用骰子按鈕
});

        let playerName = ""; // 新增全域變量        
        let score = 100;
        let playerPosition = 0;
        let totalNodesTravelled = 0;
        const totalNodes = 40;
        let completedLaps = 0; // 新增變數，追蹤完成的迴圈數
        let isGameOver = false; // 新增變數，遊戲是否結束
        const questions = {
        技術: [
        { text: "下列何者不是萬年清新人教育訓練的模組名稱？", options: ["土木基礎", "環工基礎", "監造基礎"], answer: "土木基礎" },
        { text: "EC常用的泵浦入口設計流速為多少m/s？", options: ["0.5", "1", "1.5"], answer: "1" },
        { text: "下列何者為化學需氧量英文簡稱？", options: ["COD", "CQD", "CGD"], answer: "COD" },
        { text: "結算至答題當下，萬年清總共擁有幾個商標?", options: ["8", "9", "10"], answer: "10" },
        { text: "下列哪一個工程案址所在之地理位置最南?", options: ["越南泰成", "福建泰慶", "燁興岡山 "], answer: "越南泰成" },
        { text: "2024年萬年清營收約為____，迎來歷史新高！", options: ["6億8", "6億6", "6億4"], answer: "6億4" },
        { text: "下列何者為2024年萬年清財報簽證事務所?", options: ["勤業眾信聯合會計師事務所", "資誠聯合會計師事務所", "安永聯合會計師事務所"], answer: "安永聯合會計師事務所" },
        { text: "下列何者為萬年清越南子公司所處縣市?", options: ["胡志明市", "河內市", "海防市"], answer: "胡志明市" },
        { text: "下列何者為萬年清印度公子司所處之行政區?", options: ["清奈", "新德里", "孟買"], answer: "清奈" },
        { text: "結算至答題當下，2024年萬年清新增供應商數量最接近下列哪個數字?", options: ["73", "83", "93"], answer: "93" },
        { text: "下列何者不是2024年公司同仁針對矯正預防措施單提出的永久預防對策？", options: ["欄杆類設備廠驗時，需確認高度是否符合。", "脫水機濾液正常應回至前端再行處理，如重力流無法順利流回，則需增加輸送泵。", "使用儀儀器測量時，需注意儀器使用的注意事項。"], answer: "使用儀儀器測量時，需注意儀器使用的注意事項。" },
        { text: "依本年度萬年清內部宣導措施，因人為疏失導致公務車沒電，需罰做幾次值日生？", options: ["3", "4", "5"], answer: "5" },
        { text: "以2024年為限，萬年清總共承攬了幾個P案?", options: ["14", "12", "10"], answer: "12" },
        ],
        生活: [
        { text: "2025的新年佈置中，5F(管理部)電動門旁的鞋櫃上總共擺了幾顆立體金元寶？", options: ["0", "5", "10"], answer: "5" },
        { text: "下列何者不是公司(EC)附近的平民小吃？", options: ["爆汁熊雞排", "品溱美食坊", "天涯海餃"], answer: "天涯海餃" },
        { text: "萬年清4F(研創部)的牆上，總共掛了幾張獎狀/專利/證書？", options: ["20", "30", "40"], answer: "30" },
        { text: "EC 3F會議室的「會議中」掛牌圖案上，四著人圍坐在哪裡開會？", options: ["公園", "山峰", "游泳池"], answer: "山峰" },
        { text: "下列公司周邊的店家/設施，何者不在龍富路五段？", options: ["大都會探索幼兒園", "左西人文空間", "龍吉182五金"], answer: "龍吉182五金" },
        { text: "結算至答題當下，哪一台EC公務車的里程數已經超過50萬?", options: ["2726-PW", "2727-PQ", "0253-D2"], answer: "2726-PW" },
        { text: "2024年9、10月，EC慶生會為壽星準備的是哪一家的蛋糕?", options: ["紅葉蛋糕", "麥仕佳", "Hafu"], answer: "Hafu" },
        { text: "以2024年結算，下列哪一間餐廳為萬年清聚餐次數的TOP1?", options: ["蓁大盤", "阿秋大肥鵝", "壽司郎"], answer: "阿秋大肥鵝" },
        { text: "下列何者不是萬年清辦公室名牌的配色？", options: ["綠底白字", "白底黑字", "灰底白字"], answer: "白底黑字" },
        { text: "下列何者不是萬年清2024聖誕活動出現的禮物？", options: ["有副主委腳印的卡片", "乾粉滅火器", "不鏽鋼鴛鴦鍋"], answer: "不鏽鋼鴛鴦鍋" },
        ],
        人物: [
        { text: "結算至答題當下，何副總的三樓辦公室內共有幾株植栽？", options: ["5", "6", "7"], answer: "5" },
        { text: "下列福委成員的名字，共有幾個錯字？[黃晧瑜/林亞崴/邱雁翎/卓宗煒]", options: ["5", "4", "3"], answer: "4" },
        { text: "2024萬年清舉辦的聖誕活動中，誰沒有抽到張總的加碼禮物", options: ["陳凱雯", "周怡汝", "宋宇晨"], answer: "宋宇晨" },
        { text: "林奕甫課長的Line個人主題貼圖「神奇a林yifu」中，不包含下列哪個表情？", options: ["生日快樂", "別小看我", "我還很餓"], answer: "我還很餓" },
        { text: "結算至答題當下，216是哪位EC同仁的分機號碼?", options: ["龍哥", "紘瑜", "柏廷"], answer: "龍哥" },
        { text: "2024/4/18，祺曜駕駛哪一輛公務車出差被開了一張超速罰單？", options: ["BRP-3006", "0017-WG", "ABZ-3808"], answer: "BRP-3006" },
        { text: "依照2024/11/18萬年清頒布之最新消防編制，安全防務班班長是由哪位同仁擔任？", options: ["蔡宜軒", "湯子萱", "林子軒"], answer: "蔡宜軒" },
        { text: "下列哪一位公司同仁大學不是畢業於中興環工系？", options: ["曾立德", "邵作博", "張湘棋"], answer: "曾立德" },
        { text: "下列哪一位公司同仁並未於2024年間至工案現場執行試車工作？", options: ["盧冠羽", "楊宜庭", "林子荃"], answer: "楊宜庭" },
        { text: "參照113年度公司內部提供的宣導簡報，若有誠信經營相關疑問，應洽詢哪位主管？", options: ["邱燕翎_公司治理主管", "李玠樺_稽核主管", "陳建任_協理"], answer: "邱燕翎_公司治理主管" },
        { text: "下列哪位萬年清業務部同仁的分機數字總和為10？", options: ["林世強", "林書廷", "林欣靚"], answer: "林世強" },
        { text: "2024年12月，業務部主管李俊穎協理沒有安排至下列哪個地點出差？？", options: ["豆之家", "味全", "國原院"], answer: "味全" },
        ],
        時事: [
        { text: "2024/5月，英王查爾斯三世於白金漢宮揭幕登基後的首張官方個人肖像畫。請問該畫作大量使用何種顏色做為背景？", options: ["白色", "紅色", "藍色"], answer: "紅色" },
        { text: "魷魚遊戲2是Netflix於2024年12月26日上線的原創韓國劇集，下列哪一位前Bigbang成員有參與該劇的演出?", options: ["TOP", "勝利", "太陽"], answer: "TOP" },
        { text: "現任輝達執行長黃仁勳於2025年1月抵達台灣逢甲夜市，請問這次他品嘗了哪一樣在地小吃？", options: ["雞排", "蛋沙拉", "啥都沒吃"], answer: "啥都沒吃" },
        { text: "下列何者不是2024台灣棒壇紅人陳傑憲的太太-綺綺-曾加入過的團體?", options: ["Passion Sisters", "Rhinos Angels", "Uni Girls"], answer: "Uni Girls" },
        { text: "2024棒壇金句「兄弟齊心,大家都愛短今」原文出自於下列哪位運動員之口？", options: ["周思齊", "江坤宇", "林明杰"], answer: "林明杰" },
        { text: "下列哪位藝人沒有以嘉賓身份出席2024/12月份周杰倫嘉年華世界巡迴演唱台北場次？", options: ["江蕙", "林俊傑", "張惠妹"], answer: "林俊傑" },
        { text: "西曆2024年間，下列哪位藝人/團體沒有在台灣舉辦演唱會/見面會？", options: ["5566", "Charlie Puth", "張惠妹"], answer: "5566" },
        { text: "下列哪部電影沒有在2024年的台灣上映？", options: ["哥吉拉與金剛：新帝國", "誰偷了垃圾桶？", "腦筋急轉彎2"], answer: "誰偷了垃圾桶？" },
        { text: "下列國際事件何者並非發生於2024？", options: ["日本皇室開設Instagram帳號", "巴黎聖母院重建完工，正式對外開放", "大谷翔平宣布同意以10年7億美金合約加盟道奇"], answer: "大谷翔平宣布同意以10年7億美金合約加盟道奇" },
        { text: "截至2025/02/26前，於肯德基消費結帳時輸入下列哪一組優惠碼，即可獲得購買３顆原味蛋塔免費贈１顆優惠？", options: ["14406", "14407", "14408"], answer: "14408" },
        { text: "2024巴黎奧運會上，中華台北團並未獲得哪個賽事的獎牌？", options: ["體操", "羽球", "高爾夫"], answer: "高爾夫" },
        ],
    };
        const loadHistory = () => {
            try {
                const history = JSON.parse(localStorage.getItem('gameHistory')) || [];
                historyTable.innerHTML = "";
                history.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${record.name}</td><td>${record.score}</td><td>${record.time}</td>`;
                    historyTable.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading history: ", error);
            }
        };

        const saveToHistory = (playerName, score) => {
            try {
                const history = JSON.parse(localStorage.getItem('gameHistory')) || [];
                const time = new Date().toLocaleString();
                history.push({ name: playerName, score, time });
                localStorage.setItem('gameHistory', JSON.stringify(history));
            } catch (error) {
                console.error("Error saving to history: ", error);
            }
        };

      function adjustBoardSize() {
    const board = document.querySelector('.board');
    const nodes = document.querySelectorAll('.node');
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const smallerDimension = Math.min(viewportWidth, viewportHeight);

    // 調整地圖容器大小
    const boardSize = smallerDimension * 0.9; // 地圖容器占螢幕的 90%
    board.style.width = `${boardSize}px`;
    board.style.height = `${boardSize}px`;

    // 計算每個節點的大小
    const gridSize = Math.sqrt(nodes.length); // 假設節點是正方形排列
    const nodeSize = boardSize / gridSize; // 節點大小 = 容器大小 / 格數
    nodes.forEach(node => {
        node.style.width = `${nodeSize}px`;
        node.style.height = `${nodeSize}px`;
        node.style.fontSize = `${nodeSize / 5}px`; // 調整文字大小
    });
}

// 當視窗大小改變時執行
window.addEventListener('resize', adjustBoardSize);

// 頁面加載時執行一次
adjustBoardSize();

const specialCorners = []; // 儲存特殊角落的索引

const createNodes = () => {
    for (let i = 0; i < 11; i++) {
        for (let j = 0; j < 11; j++) {
            const node = document.createElement('div');
            const isEdge = (i === 0 || i === 10 || j === 0 || j === 10);
            const isCorner = (i === 0 && j === 0) || (i === 0 && j === 10) || 
                           (i === 10 && j === 0) || (i === 10 && j === 10);

            if (isCorner) {
                node.classList.add('node', 'corner');
                
                // 左上角設為起始點
                if (i === 0 && j === 0) {
                    node.textContent = 'START';
                    node.dataset.name = 'start';
                } else {
                    node.textContent = '特殊角落';
                    node.dataset.name = '特殊角落';
                }
                
                const cornerIndex = calculateNodeIndex(i, j);
                node.dataset.index = cornerIndex;
                specialCorners.push(cornerIndex);
            } else if (isEdge) {
                node.classList.add('node', 'path');
                const nodeIndex = calculateNodeIndex(i, j);
                const categoryNames = ['技術', '生活', '人物', '時事'];
                const category = categoryNames[nodeIndex % 4];
                node.dataset.category = category;
                node.dataset.name = category;
                node.textContent = category;
                node.dataset.index = nodeIndex;
            } else {
                node.classList.add('node', 'hidden-node');
            }
            
            board.appendChild(node);
        }
    }
};

function adjustNodeStyles() {
    const isSmallScreen = window.innerWidth < 600;
    const nodes = document.querySelectorAll('.node');
    nodes.forEach(node => {
        if (isSmallScreen) {
            node.style.fontSize = "10px"; /* 縮小文字 */
            node.style.padding = "2px";  /* 減少節點邊距 */
        } else {
            node.style.fontSize = "14px"; /* 恢復預設大小 */
            node.style.padding = "5px";
        }
    });
}

// 當使用者改變裝置尺寸時觸發
window.addEventListener('resize', adjustNodeStyles);

// 頁面加載時立即檢查一次
adjustNodeStyles();

        function calculateNodeIndex(row, col) {
            if (row === 0) return col;
            if (col === 10) return 10 + row;
            if (row === 10) return 30 - col;
            if (col === 0) return 30 + (10 - row);
            return null;
        }

        function updatePlayerPosition() {
    const nodes = document.querySelectorAll('.node');
    
    // 重置所有節點的內容
    nodes.forEach(node => {
        const category = node.dataset.category || node.dataset.name || '';
        node.innerHTML = ''; // 確保內容被清空
        
        // 插入類別名稱
        const categorySpan = document.createElement('span');
        categorySpan.textContent = category;
        node.appendChild(categorySpan);
    });

    // 找到玩家所在的節點
    const currentNode = [...nodes].find(node => node.dataset.index == playerPosition);
    if (currentNode) {
        const playerElement = document.createElement('div');
        playerElement.classList.add('player');
        playerElement.textContent = "P";
        currentNode.appendChild(playerElement);
    }
}

      function checkSpecialCorner(position) {
    const nodes = document.querySelectorAll('.node');
    const currentNode = [...nodes].find(node => node.dataset.index == position);

    if (currentNode && currentNode.classList.contains('corner')) {
        handleSpecialCorner(currentNode.dataset.name);
    }
}

function handleSpecialCorner(cornerName) {
    if (cornerName === 'start') {
    rollDiceButton.disabled = false;
    return;
}
    switch (cornerName) {
        case '特殊角落':
            alert("歡迎來到特殊角落！你獲得了 50 分獎勵！");
            score += 50;
            break;
        default:
            alert(`你進入了 ${cornerName}，但目前沒有定義的行動。`);
            break;
    }

    // 更新分數顯示
    scoreDisplay.textContent = score;

    // 隱藏「是否答題」和其他相關視窗
    choiceContainer.style.display = "none";
    questionContainer.style.display = "none";

    // 啟用骰子按鈕，允許玩家繼續遊戲
    rollDiceButton.disabled = false;
}
           
        function updateDiceFace(value) {
            const dots = [
                [],
                [4],
                [0, 8],
                [0, 4, 8],
                [0, 2, 6, 8],
                [0, 2, 4, 6, 8],
                [0, 2, 3, 5, 6, 8]
            ];
            diceFace.innerHTML = "";
            for (let i = 0; i < 9; i++) {
                const dot = document.createElement('div');
                dot.className = dots[value].includes(i) ? 'dot' : '';
                diceFace.appendChild(dot);
            }
        }

        rollDiceButton.addEventListener('click', () => {
    if (isGameOver) return;

    diceFace.classList.add('animate');
    rollDiceButton.disabled = true;

    const diceResult = 6;

    let rollingInterval = setInterval(() => {
        const randomValue = Math.floor(Math.random() * 6) + 1;
        updateDiceFace(randomValue);
    }, 100);

    setTimeout(() => {
        clearInterval(rollingInterval);
        diceFace.classList.remove('animate');
        updateDiceFace(diceResult);
        diceResultDisplay.textContent = diceResult;

        totalNodesTravelled += diceResult;

        const newLaps = Math.floor(totalNodesTravelled / totalNodes);

        if (newLaps >= 1) {
        alert("遊戲結束！你完成了 3 個完整迴圈！");
        console.log("遊戲結束時的 playerName:", playerName);
        isGameOver = true;
        GameState.clearState(); // 清除遊戲狀態
        handleGameEnd();
        rollDiceButton.disabled = true;
        rollDiceButton.textContent = "遊戲結束";
        return;
    }

        playerPosition = (playerPosition + diceResult) % totalNodes;
        updatePlayerPosition();

        setTimeout(() => {
            if (newLaps > completedLaps) {
                completedLaps = newLaps;
                alert(`恭喜！你完成了第 ${completedLaps} 個迴圈！`);
            }

            // 判斷是特殊角落還是普通節點
            if (specialCorners.includes(playerPosition)) {
                handleSpecialCorner('特殊角落');
            } else {
                // 顯示是否答題的選項
                choiceContainer.style.display = "block";
                rollDiceButton.disabled = true; // 禁用骰子按鈕，等待答題或扣分
            }
        }, 500);
    }, 1000);
});

// 修改 handleGameEnd 函數
function handleGameEnd() {
    GameState.clearState(); // 清除遊戲狀態
    const wishModal = document.getElementById('wishModal');
    const wishOverlay = document.getElementById('wishOverlay');
    const wishForm = document.getElementById('wishForm');
    
    wishModal.style.display = 'block';
    wishOverlay.style.display = 'block';
    
    wishForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const wishText = wishForm.querySelector('textarea').value.trim();
        sendGameResult(playerName, score, wishText);
        
        wishModal.style.display = 'none';
        wishOverlay.style.display = 'none';
    });
}
        // 3. 新增遊戲初始化函數
function initializeGame() {
    if (GameState.hasActiveGame()) {
        const savedState = GameState.loadState();
        if (savedState && GameState.isStateValid(savedState)) {
            const confirmResume = confirm('檢測到未完成的遊戲，是否要繼續？');
            if (confirmResume) {
                restoreGameState(savedState);
                return true;
            }
        }
        GameState.clearState();
    }
    return false;
}

// 4. 新增遊戲狀態恢復函數
function restoreGameState(savedState) {
    playerName = savedState.playerName;
    score = savedState.score;
    playerPosition = savedState.playerPosition;
    totalNodesTravelled = savedState.totalNodesTravelled;
    completedLaps = savedState.completedLaps;
    isGameOver = savedState.isGameOver;
    
    nameInput.value = playerName;
    nameInput.disabled = true;
    document.getElementById('startGame').disabled = true;
    board.style.display = "grid";
    gameControls.style.display = "block";
    document.querySelector('.controls').style.display = "none";
    scoreDisplay.textContent = score;
    
    updatePlayerPosition();
}

// 5. 新增自動保存設置函數
function setupAutosave() {
    const AUTOSAVE_INTERVAL = 5000; // 每5秒自動保存
    
    setInterval(() => {
        if (!isGameOver) {
            GameState.saveState({
                playerName,
                score,
                playerPosition,
                totalNodesTravelled,
                completedLaps,
                isGameOver
            });
        }
    }, AUTOSAVE_INTERVAL);
}

        function askQuestion(position) {
    if (isGameOver) return;

    const nodes = document.querySelectorAll('.node');
    const currentNode = [...nodes].find(node => node.dataset.index == position);

    if (!currentNode) {
        console.error("無法找到當前節點，位置：", position);
        return;
    }

    const category = currentNode.dataset.category;
    if (!category) {
        console.warn("當前節點沒有分類，跳過答題。");
        return;
    }

    const questionPool = questions[category];
    if (!questionPool || questionPool.length === 0) {
        console.warn("無可用題目，分類：", category);
        return;
    }

    const questionIndex = Math.floor(Math.random() * questionPool.length);
    const question = questionPool[questionIndex];

    questionText.textContent = question.text;
    optionsContainer.innerHTML = "";

    question.options.forEach(option => {
        const button = document.createElement('button');
        button.textContent = option;
        button.addEventListener('click', () => {
            handleAnswer(option === question.answer);
        });
        optionsContainer.appendChild(button);
    });

    questionContainer.style.display = "block";
    rollDiceButton.disabled = true;
}
      function handleAnswer(isCorrect) {
    if (isCorrect) {
        alert("答對了！加10分！");
        score += 10;
    } else {
        alert("答錯了！扣10分！");
        score -= 10;
    }

    // 更新分數顯示
    scoreDisplay.textContent = score;

    // 隱藏問題容器
    questionContainer.style.display = "none";

    // 啟用擲骰按鈕
    if (!isGameOver) rollDiceButton.disabled = false;
}

// 將這段程式碼加在 JavaScript 的最後面
document.addEventListener('DOMContentLoaded', () => {
    if (!initializeGame()) {
        setupAutosave();
        
        const startGameButton = document.getElementById('startGame');
        const newButton = startGameButton.cloneNode(true);
        startGameButton.parentNode.replaceChild(newButton, startGameButton);
        
        newButton.addEventListener('click', () => {
            console.log("輸入框值:", nameInput.value);
            playerName = nameInput.value.trim();
            console.log("存儲後的 playerName:", playerName);
            
            if (!playerName || playerName.length > 20 || !/^[\w\u4e00-\u9fa5]+$/.test(playerName)) {
                alert("請輸入有效的名字（20 字以內，僅包含字母、數字或中文）！");
                return;
            }
            
            nameInput.disabled = true;
            newButton.disabled = true;
            
            board.style.display = "grid";
            gameControls.style.display = "block";
            
            document.querySelector('.controls').style.display = "none";
            
            updatePlayerPosition();
            setupAutosave(); // 開始自動保存
        });
    }
});
        window.addEventListener('beforeunload', function(e) {
    if (!isGameOver && GameState.hasActiveGame()) {
        e.preventDefault();
        e.returnValue = '遊戲尚未結束，確定要離開嗎？';
        return e.returnValue;
    }
});
        
        loadHistory();
        createNodes();
        updatePlayerPosition();
        updateDiceFace(1);
    </script>
</body>
</html>
