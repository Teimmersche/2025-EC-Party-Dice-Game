<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025尾牙遊戲</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Noto Sans TC', sans-serif;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .game-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .title {
            font-size: 1.75rem;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1rem;
        }

        .input-group {
            margin: 1.5rem 0;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .button {
            background-color: #4a5568;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button:hover {
            background-color: #2d3748;
        }

        .rules-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .rules-title {
            font-size: 1.25rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .rules-list {
            list-style: none;
            padding: 0;
        }

        .rules-list li {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .rules-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #4a5568;
        }

        .question-modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .question-title {
            font-size: 1.25rem;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .choice-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .choice-button {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: #f8f9fa;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s;
        }

        .choice-button:hover {
            background: #4a5568;
            color: white;
        }

        @media (max-width: 640px) {
            .container {
                padding: 1rem;
                margin: 1rem;
            }
        }
    </style>

</head>
<body>
    <div class="container">
        <div class="game-card">
            <h1 class="title">2025尾牙遊戲</h1>
            
            <div class="input-group">
                <label class="input-label">玩家名稱</label>
                <input type="text" class="input-field" placeholder="請輸入您的名字">
                <button class="button">開始遊戲</button>
            </div>

            <div class="rules-section">
                <h2 class="rules-title">遊戲規則</h2>
                <ul class="rules-list">
                    <li>玩家從起點開始，擲骰子決定前進步數</li>
                    <li>落在問答格需回答該類別題目：答對+10分，答錯-10分</li>
                    <li>可選擇跳過回答，但會扣10分</li>
                    <li>特殊角落可獲得50分</li>
                    <li>繞完一圈即可結束遊戲</li>
                </ul>
            </div>
        </div>

        <div class="question-modal" style="display: none;">
            <h2 class="question-title">是否答題？</h2>
            <div class="choice-buttons">
                <button class="choice-button">答題</button>
                <button class="choice-button">跳過 (-10分)</button>
            </div>
        </div>
    </div>
</body>
</html>
    <script>
        // Google Apps Script 網頁應用程式網址
const googleAppsScriptUrl = 'https://script.google.com/macros/s/AKfycbywP4H7lBXRaSjXG-IxbWx_5qf7Z24XgGqAkd-d8U6Qrwkli0HShRA6ypIrt19E1akcSA/exec'; // 替換為您的網址

// 傳送遊戲結果到 Google Sheets 的函式
// 修正後的 sendGameResult 函數
function sendGameResult(playerName, score, wish) {
    // 確保所有參數都經過正確編碼
    const encodedParams = new URLSearchParams({
        playerName: encodeURIComponent(playerName),
        score: encodeURIComponent(score),
        wish: encodeURIComponent(wish || '')
    });

    const url = `${googleAppsScriptUrl}?${encodedParams.toString()}`;
    console.log('發送請求:', url);

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('回應:', data);
            if (data.status === 'success') {
                saveToHistory(playerName, score);
                alert('遊戲紀錄已成功儲存！');
            } else {
                throw new Error(data.message || '儲存失敗');
            }
        })
        .catch(error => {
            console.error('錯誤:', error);
            alert(`儲存失敗: ${error.message}`);
        });
}

        const board = document.getElementById('board');
        const gameControls = document.getElementById('gameControls');
        const scoreDisplay = document.getElementById('score');
        const diceResultDisplay = document.getElementById('diceResult');
        const rollDiceButton = document.getElementById('rollDice');
        const nameInput = document.getElementById('name');
        const Button = document.getElementById('');
        const scoreboardTable = document.getElementById('scoreboard');
        const historyTable = document.getElementById('history');
        const questionContainer = document.getElementById('questionContainer');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('options');
        const diceFace = document.getElementById('diceFace');
      const choiceContainer = document.getElementById('choiceContainer');
const answerButton = document.getElementById('answerButton');
const passButton = document.getElementById('passButton');

document.getElementById('startGame').addEventListener('click', () => {
    playerName = nameInput.value.trim();
    
    if (!playerName || playerName.length > 20 || !/^[\w\u4e00-\u9fa5]+$/.test(playerName)) {
        alert("請輸入有效的名字（20 字以內，僅包含字母、數字或中文）！");
        return;
    }
    
    document.querySelector('.welcome-screen').style.display = 'none';
    document.querySelector('.game-screen').style.display = 'block';
    
    createNodes();
    updatePlayerPosition();
    updateDiceFace(1);
});
        
// 玩家選擇答題
answerButton.addEventListener('click', () => {
    choiceContainer.style.display = "none"; // 隱藏選擇視窗
    askQuestion(playerPosition); // 呼叫題目顯示函數
});

// 玩家選擇跳過
passButton.addEventListener('click', () => {
    choiceContainer.style.display = "none"; // 隱藏選擇視窗
    score -= 10; // 扣除10分
    scoreDisplay.textContent = score; // 更新分數顯示
    rollDiceButton.disabled = false; // 啟用骰子按鈕
});

        let playerName = ""; // 新增全域變量        
        let score = 100;
        let playerPosition = 0;
        let totalNodesTravelled = 0;
        const totalNodes = 28;
        let completedLaps = 0; // 新增變數，追蹤完成的迴圈數
        let isGameOver = false; // 新增變數，遊戲是否結束
        const questions = {
        技術: [
        { text: "HTML 是什麼的縮寫？", options: ["Hyper Text Markup Language", "Hyperlink and Text Module", "Home Tool Markup Language"], answer: "Hyper Text Markup Language" },
        { text: "JavaScript 是一種什麼語言？", options: ["靜態語言", "動態語言", "標記語言"], answer: "動態語言" },
        { text: "技術測試題1", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題2", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題3", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題4", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題5", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題6", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題7", options: ["A", "B", "C"], answer: "A" },
        { text: "技術測試題8", options: ["A", "B", "C"], answer: "A" },
        ],
        生活: [
        { text: "早餐不吃會對身體造成什麼影響？", options: ["增加新陳代謝", "降低血糖", "沒有影響"], answer: "降低血糖" },
        { text: "生活測試題1", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題2", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題3", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題4", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題5", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題6", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題7", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題8", options: ["A", "B", "C"], answer: "A" },
        { text: "生活測試題9", options: ["A", "B", "C"], answer: "A" },
        ],
        人物: [
        { text: "愛因斯坦最著名的理論是什麼？", options: ["量子力學", "相對論", "熱力學"], answer: "相對論" },
        { text: "人物測試題1", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題2", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題3", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題4", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題5", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題6", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題7", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題8", options: ["A", "B", "C"], answer: "A" },
        { text: "人物測試題9", options: ["A", "B", "C"], answer: "A" },
        ],
        時事: [
        { text: "2025 年世界的最新科技趨勢是什麼？", options: ["人工智慧", "量子計算", "區塊鏈"], answer: "人工智慧" },
        { text: "時事測試題1", options: ["A", "B", "C"], answer: "A" },
        { text: "時事測試題2", options: ["A", "B", "C"], answer: "B" },
        { text: "時事測試題3", options: ["A", "B", "C"], answer: "A" },
        { text: "時事測試題4", options: ["A", "B", "C"], answer: "C" },
        { text: "時事測試題5", options: ["A", "B", "C"], answer: "A" },
        { text: "時事測試題6", options: ["A", "B", "C"], answer: "A" },
        { text: "時事測試題7", options: ["A", "B", "C"], answer: "A" },
        { text: "時事測試題8", options: ["A", "B", "C"], answer: "C" },
        { text: "時事測試題9", options: ["A", "B", "C"], answer: "B" },
        ],
    };
        const loadHistory = () => {
            try {
                const history = JSON.parse(localStorage.getItem('gameHistory')) || [];
                historyTable.innerHTML = "";
                history.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${record.name}</td><td>${record.score}</td><td>${record.time}</td>`;
                    historyTable.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading history: ", error);
            }
        };

        const saveToHistory = (playerName, score) => {
            try {
                const history = JSON.parse(localStorage.getItem('gameHistory')) || [];
                const time = new Date().toLocaleString();
                history.push({ name: playerName, score, time });
                localStorage.setItem('gameHistory', JSON.stringify(history));
            } catch (error) {
                console.error("Error saving to history: ", error);
            }
        };

      function adjustBoardSize() {
    const board = document.querySelector('.board');
    const nodes = document.querySelectorAll('.node');
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const smallerDimension = Math.min(viewportWidth, viewportHeight);

    // 調整地圖容器大小
    const boardSize = smallerDimension * 0.9; // 地圖容器占螢幕的 90%
    board.style.width = `${boardSize}px`;
    board.style.height = `${boardSize}px`;

    // 計算每個節點的大小
    const gridSize = Math.sqrt(nodes.length); // 假設節點是正方形排列
    const nodeSize = boardSize / gridSize; // 節點大小 = 容器大小 / 格數
    nodes.forEach(node => {
        node.style.width = `${nodeSize}px`;
        node.style.height = `${nodeSize}px`;
        node.style.fontSize = `${nodeSize / 5}px`; // 調整文字大小
    });
}

// 當視窗大小改變時執行
window.addEventListener('resize', adjustBoardSize);

// 頁面加載時執行一次
adjustBoardSize();

const specialCorners = []; // 儲存特殊角落的索引

function createNodes() {
    // 清空現有的board
    board.innerHTML = '';
    
    for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
            const node = document.createElement('div');
            const isEdge = (i === 0 || i === 7 || j === 0 || j === 7);
            const isCorner = (i === 0 && j === 0) || (i === 0 && j === 7) || 
                           (i === 7 && j === 0) || (i === 7 && j === 7);

            if (isCorner) {
                node.classList.add('node', 'corner');
                node.textContent = '特殊角落';
                node.dataset.name = '特殊角落';
                
                const cornerIndex = calculateNodeIndex(i, j);
                node.dataset.index = cornerIndex;
                specialCorners.push(cornerIndex);
            } else if (isEdge) {
                node.classList.add('node', 'path');
                const nodeIndex = calculateNodeIndex(i, j);
                const categoryNames = ['技術', '生活', '人物', '時事'];
                const category = categoryNames[nodeIndex % 4];
                node.dataset.category = category;
                node.dataset.name = category;
                node.textContent = category;
                node.dataset.index = nodeIndex;
            } else {
                node.classList.add('node', 'hidden-node');
            }

            board.appendChild(node);
        }
    }
}

function adjustNodeStyles() {
    const isSmallScreen = window.innerWidth < 600;
    const nodes = document.querySelectorAll('.node');
    nodes.forEach(node => {
        if (isSmallScreen) {
            node.style.fontSize = "10px"; /* 縮小文字 */
            node.style.padding = "2px";  /* 減少節點邊距 */
        } else {
            node.style.fontSize = "14px"; /* 恢復預設大小 */
            node.style.padding = "5px";
        }
    });
}

// 當使用者改變裝置尺寸時觸發
window.addEventListener('resize', adjustNodeStyles);

// 頁面加載時立即檢查一次
adjustNodeStyles();

// 修改節點索引計算函數
        function calculateNodeIndex(row, col) {
            if (row === 0) return col;                    // 頂部行
            if (col === 7) return 7 + row;                // 右側列
            if (row === 7) return 21 - col;               // 底部行
            if (col === 0) return 28 - row;               // 左側列
            return null;
        }

        function updatePlayerPosition() {
    const nodes = document.querySelectorAll('.node');
    
    // 重置所有節點的內容
    nodes.forEach(node => {
        const category = node.dataset.category || node.dataset.name || '';
        node.innerHTML = ''; // 確保內容被清空
        
        // 插入類別名稱
        const categorySpan = document.createElement('span');
        categorySpan.textContent = category;
        node.appendChild(categorySpan);
    });

    // 找到玩家所在的節點
    const currentNode = [...nodes].find(node => node.dataset.index == playerPosition);
    if (currentNode) {
        const playerElement = document.createElement('div');
        playerElement.className = 'player bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold';
        playerElement.classList.add('player');
        playerElement.textContent = "P";
        currentNode.appendChild(playerElement);
    }
}

      function checkSpecialCorner(position) {
    const nodes = document.querySelectorAll('.node');
    const currentNode = [...nodes].find(node => node.dataset.index == position);

    if (currentNode && currentNode.classList.contains('corner')) {
        handleSpecialCorner(currentNode.dataset.name);
    }
}

function handleSpecialCorner(cornerName) {
    switch (cornerName) {
        case '特殊角落':
            alert("歡迎來到特殊角落！你獲得了 50 分獎勵！");
            score += 50;
            break;
        default:
            alert(`你進入了 ${cornerName}，但目前沒有定義的行動。`);
            break;
    }

    // 更新分數顯示
    scoreDisplay.textContent = score;

    // 隱藏「是否答題」和其他相關視窗
    choiceContainer.style.display = "none";
    questionContainer.style.display = "none";

    // 啟用骰子按鈕，允許玩家繼續遊戲
    rollDiceButton.disabled = false;
}
           
        function updateDiceFace(value) {
            const dots = [
                [],
                [4],
                [0, 8],
                [0, 4, 8],
                [0, 2, 6, 8],
                [0, 2, 4, 6, 8],
                [0, 2, 3, 5, 6, 8]
            ];
            diceFace.innerHTML = "";
            for (let i = 0; i < 9; i++) {
                const dot = document.createElement('div');
                dot.className = dots[value].includes(i) ? 'dot' : '';
                diceFace.appendChild(dot);
            }
        }

        rollDiceButton.addEventListener('click', () => {
    if (isGameOver) return;

    diceFace.classList.add('animate');
    rollDiceButton.disabled = true;

    const diceResult = Math.floor(Math.random() * 6) + 1;

    let rollingInterval = setInterval(() => {
        const randomValue = Math.floor(Math.random() * 6) + 1;
        updateDiceFace(randomValue);
    }, 100);

    setTimeout(() => {
        clearInterval(rollingInterval);
        diceFace.classList.remove('animate');
        updateDiceFace(diceResult);
        diceResultDisplay.textContent = diceResult;

        totalNodesTravelled += diceResult;

        const newLaps = Math.floor(totalNodesTravelled / totalNodes);

        if (newLaps >= 1) {
    alert("遊戲結束！你完成了一個完整迴圈！");
    isGameOver = true;
    handleGameEnd(); // 移除wish參數的傳遞
    rollDiceButton.disabled = true;
    rollDiceButton.textContent = "遊戲結束";
    return;
}

        playerPosition = (playerPosition + diceResult) % totalNodes;
        updatePlayerPosition();

        setTimeout(() => {
            if (newLaps > completedLaps) {
                completedLaps = newLaps;
                alert(`恭喜！你完成了第 ${completedLaps} 個迴圈！`);
            }

            // 判斷是特殊角落還是普通節點
            if (specialCorners.includes(playerPosition)) {
                handleSpecialCorner('特殊角落');
            } else {
                // 顯示是否答題的選項
                choiceContainer.style.display = "block";
                rollDiceButton.disabled = true; // 禁用骰子按鈕，等待答題或扣分
            }
        }, 500);
    }, 1000);
});

function handleGameEnd() {
    const wishModal = document.getElementById('wishModal');
    const wishOverlay = document.getElementById('wishOverlay');
    const wishForm = document.getElementById('wishForm');

    wishModal.style.display = 'block';
    wishOverlay.style.display = 'block';

    wishForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const wishText = this.querySelector('textarea').value;
        
        // 確保 playerName 是有效的
        const finalPlayerName = playerName || nameInput.value.trim();
        if (!finalPlayerName) {
            alert('無法獲取玩家名稱');
            return;
        }

        // 傳送結果
        sendGameResult(finalPlayerName, score, wishText);
        
        // 關閉模態視窗
        wishModal.style.display = 'none';
        wishOverlay.style.display = 'none';
    });
}

        function askQuestion(position) {
    if (isGameOver) return;

    const nodes = document.querySelectorAll('.node');
    const currentNode = [...nodes].find(node => node.dataset.index == position);

    if (!currentNode) {
        console.error("無法找到當前節點，位置：", position);
        return;
    }

    const category = currentNode.dataset.category;
    if (!category) {
        console.warn("當前節點沒有分類，跳過答題。");
        return;
    }

    const questionPool = questions[category];
    if (!questionPool || questionPool.length === 0) {
        console.warn("無可用題目，分類：", category);
        return;
    }

    const questionIndex = Math.floor(Math.random() * questionPool.length);
    const question = questionPool[questionIndex];

    questionText.textContent = question.text;
    optionsContainer.innerHTML = "";

    question.options.forEach(option => {
        const button = document.createElement('button');
        button.className = 'question-option';
        button.textContent = option;
        button.addEventListener('click', () => {
            handleAnswer(option === question.answer);
        });
        optionsContainer.appendChild(button);
    });

    questionContainer.style.display = "block";
    questionContainer.style.display = "flex";
    rollDiceButton.disabled = true;
}
      function handleAnswer(isCorrect) {
    if (isCorrect) {
        alert("答對了！加10分！");
        score += 10;
    } else {
        alert("答錯了！扣10分！");
        score -= 10;
    }

    // 更新分數顯示
    scoreDisplay.textContent = score;

    // 隱藏問題容器
    questionContainer.style.display = "none";

    // 啟用擲骰按鈕
    if (!isGameOver) rollDiceButton.disabled = false;
}
        
        loadHistory();
        createNodes();
        updatePlayerPosition();
        updateDiceFace(1);
    </script>
</body>
</html>

